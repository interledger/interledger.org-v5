---
import FoundationBlogLayout from '../../layouts/FoundationBlogLayout.astro'
import CommunityLinks from '../../components/blog/CommunityLinks.astro'
import { fetchStrapi } from '../../utils/fetchStrapi'
import { marked } from 'marked'

// Get the documentId from the query string
export const prerender = false
const documentId = Astro.url.searchParams.get('slug')
if (!documentId) {
  throw new Error('Missing documentId in preview URL')
}

// Always fetch draft content for preview
const response = await fetchStrapi(`api/blog-posts/${documentId}?status=draft`)

const article = response?.data

if (!article) {
  throw new Error(`Preview: No article found for documentId "${documentId}"`)
}

// Map Strapi fields to FoundationBlogLayout frontmatter
const frontmatter = {
  title: article.title,
  description: article.description,
  date: article.publishedAt,
  featureImage: article.featuredImage?.url,
  featureImageAlt: article.featuredImage?.alternativeText,
  ogImageUrl: article.ogImageUrl
}

const bodyHtml = marked.parse(article.content ? article.content : '')
---

<FoundationBlogLayout frontmatter={frontmatter}>
  <article set:html={bodyHtml} />
  <CommunityLinks />
</FoundationBlogLayout>
