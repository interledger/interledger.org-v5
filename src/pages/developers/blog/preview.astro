---
import TechBlogLayout from '../../../layouts/TechBlogLayout.astro'
import CommunityLinks from '../../../components/blog/CommunityLinks.astro'
import { fetchStrapi } from '../../../utils/fetchStrapi'
import { marked } from 'marked'

// Get the documentId from the query string
export const prerender = false
const documentId = Astro.url.searchParams.get('slug')
if (!documentId) {
  throw new Error('Missing documentId in preview URL')
}

// Always fetch draft content for preview
const response = await fetchStrapi(
  `api/tech-blog-posts/${documentId}?status=draft`
)

const article = response?.data

if (!article) {
  throw new Error(`Preview: No article found for documentId "${documentId}"`)
}

// Map Strapi fields to TechBlogLayout frontmatter
const frontmatter = {
  title: article.title,
  description: article.description,
  date: article.publishedAt,
  featureImage: article.featuredImage?.url,
  image: article.featuredImage?.url,
  featureImageAlt: article.featuredImage?.alternativeText,
  ogImageUrl: article.ogImageUrl
}

const bodyHtml = marked.parse(article.content ? article.content : '')
---

<TechBlogLayout frontmatter={frontmatter}>
  <article set:html={bodyHtml} />
  <CommunityLinks />
</TechBlogLayout>
