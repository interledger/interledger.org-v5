---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../layouts/BaseLayout.astro'
import DynamicZone from '../components/blocks/DynamicZone.astro'
import LinkArrow from '../../public/img/icon-link-arrow.svg'

// Try to fetch homepage from Strapi Pages collection (slug: "home")
async function getHomepageFromStrapi() {
  const token = import.meta.env.STRAPI_PREVIEW_TOKEN
  const base = import.meta.env.STRAPI_URL

  if (!token || !base) {
    return null
  }

  try {
    const response = await fetch(
      `${base}/api/pages?filters[slug][$eq]=home&populate[hero][populate]=*&populate[content][populate]=*&populate[seo][populate]=*`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    )
    if (!response.ok) {
      console.log(`Strapi Pages API returned ${response.status}`)
      return null
    }
    const data = await response.json()
    return data.data?.[0] || null
  } catch (error) {
    console.error('Strapi homepage fetch failed:', error)
    return null
  }
}

const strapiData = await getHomepageFromStrapi()

// Fallback to MDX content if Strapi not available
let MdxContent: typeof import('astro').AstroComponentFactory | null = null
let mdxData: {
  title?: string
  heroTitle?: string
  heroDescription?: string
} | null = null

if (!strapiData) {
  const pages = await getCollection('foundation-pages')
  const homePage = pages.find((page) => page.data.slug === 'home')

  if (homePage) {
    const { Content } = await render(homePage)
    MdxContent = Content
    mdxData = homePage.data
  }
}

// Use Strapi data if available, otherwise fall back to MDX
const title =
  strapiData?.seo?.metaTitle || mdxData?.title || 'Interledger Foundation'
const heroTitle = strapiData?.hero?.title || mdxData?.heroTitle || 'Interledger'
const heroDescription =
  strapiData?.hero?.description || mdxData?.heroDescription || ''
const heroCtas = strapiData?.hero?.secondaryCtas || []
const dynamicContent = strapiData?.content || []
const hasStrapiContent = strapiData && dynamicContent.length > 0
---

<BaseLayout title={title}>
  <main class="pb-space-l">
    <section
      class="bg-gradient-primary bg-no-repeat bg-cover bg-[position:bottom_right] min-h-[50vh] py-space-xl text-white flex items-center"
    >
      <div class="mx-auto w-full max-w-wide px-space-m">
        <div class="max-w-narrow">
          <h1
            class="text-white max-w-[14em] leading-[1.2] font-semibold mb-space-xs text-[clamp(2rem,5vw,3.5rem)]"
          >
            {heroTitle}
          </h1>
          <p class="mb-space-m text-[1.25rem] max-w-[600px]">
            {heroDescription}
          </p>
          {
            heroCtas.length > 0 && (
              <div class="flex flex-wrap items-center gap-space-s max-[600px]:flex-col max-[600px]:items-start">
                {heroCtas.map(
                  (
                    cta: {
                      link: string
                      text: string
                      analytics_event_label?: string
                      external?: boolean
                    },
                    index: number
                  ) => (
                    <a
                      class={`group inline-flex items-center gap-space-2xs rounded-pill no-underline cursor-pointer ${index === 0 ? 'bg-white text-primary px-space-s py-space-xs hover:text-primary' : 'bg-transparent border-2 border-white text-white px-space-s py-space-xs hover:bg-white hover:text-primary'}`}
                      href={cta.link}
                      data-umami-event={
                        cta.analytics_event_label || `Home - ${cta.text}`
                      }
                      {...(cta.external
                        ? { target: '_blank', rel: 'noopener noreferrer' }
                        : {})}
                    >
                      <span class="underline decoration-transparent underline-offset-4 transition-[text-decoration-color] duration-200 group-hover:decoration-current">
                        {cta.text}
                      </span>{' '}
                      <LinkArrow />
                    </a>
                  )
                )}
              </div>
            )
          }
        </div>
      </div>
    </section>

    {/* Strapi dynamic content blocks */}
    {
      hasStrapiContent && (
        <section class="py-space-xl">
          <div class="mx-auto max-w-content min-w-[360px] max-[1324px]:px-[5%]">
            <DynamicZone blocks={dynamicContent} />
          </div>
        </section>
      )
    }

    {/* Fallback MDX content */}
    {
      !hasStrapiContent && MdxContent && (
        <section class="py-space-xl">
          <div class="mx-auto max-w-content min-w-[360px] max-[1324px]:px-[5%]">
            <div class="mx-auto max-w-narrow [&_h2]:mt-space-l [&_h2]:mb-space-s [&_h2]:text-[1.75rem] [&_h2]:font-semibold [&_h2]:text-primary [&_h3]:mt-space-m [&_h3]:mb-space-xs [&_h3]:text-[1.25rem] [&_h3]:font-semibold [&_p]:mb-space-s [&_p]:leading-[1.6] [&_ul]:mb-space-s [&_ul]:ps-space-m [&_li]:mb-space-xs [&_a]:text-primary [&_a]:underline [&_a:hover]:no-underline [&_.cta-group]:my-space-m [&_.cta-group]:flex [&_.cta-group]:flex-wrap [&_.cta-group]:gap-space-s [&_.cta-group_a]:rounded-pill [&_.cta-group_a]:bg-primary [&_.cta-group_a]:px-space-s [&_.cta-group_a]:py-space-xs [&_.cta-group_a]:text-white [&_.cta-group_a]:no-underline [&_.cta-group_a:hover]:opacity-90">
              <MdxContent />
            </div>
          </div>
        </section>
      )
    }
  </main>
</BaseLayout>
