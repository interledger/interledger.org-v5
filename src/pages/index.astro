---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../layouts/BaseLayout.astro'
import DynamicZone from '../components/blocks/DynamicZone.astro'
import LinkArrow from '../../public/img/icon-link-arrow.svg'

// Try to fetch homepage from Strapi Pages collection (slug: "home")
async function getHomepageFromStrapi() {
  const token = import.meta.env.STRAPI_PREVIEW_TOKEN
  const base = import.meta.env.STRAPI_URL

  if (!token || !base) {
    return null
  }

  try {
    const response = await fetch(
      `${base}/api/pages?filters[slug][$eq]=home&populate[hero][populate]=*&populate[content][populate]=*&populate[seo][populate]=*`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    )
    if (!response.ok) {
      console.log(`Strapi Pages API returned ${response.status}`)
      return null
    }
    const data = await response.json()
    return data.data?.[0] || null
  } catch (error) {
    console.error('Strapi homepage fetch failed:', error)
    return null
  }
}

const strapiData = await getHomepageFromStrapi()

// Fallback to MDX content if Strapi not available
let MdxContent: typeof import('astro').AstroComponentFactory | null = null
let mdxData: {
  title?: string
  heroTitle?: string
  heroDescription?: string
} | null = null

if (!strapiData) {
  const pages = await getCollection('pages')
  const homePage = pages.find((page) => page.data.slug === 'home')

  if (homePage) {
    const { Content } = await render(homePage)
    MdxContent = Content
    mdxData = homePage.data
  }
}

// Use Strapi data if available, otherwise fall back to MDX
const title =
  strapiData?.seo?.metaTitle || mdxData?.title || 'Interledger Foundation'
const heroTitle = strapiData?.hero?.title || mdxData?.heroTitle || 'Interledger'
const heroDescription =
  strapiData?.hero?.description || mdxData?.heroDescription || ''
const heroCtas = strapiData?.hero?.secondaryCtas || []
const dynamicContent = strapiData?.content || []
const hasStrapiContent = strapiData && dynamicContent.length > 0
---

<BaseLayout title={title}>
  <main>
    <section class="hero">
      <div class="content-wrapper">
        <div class="text-wrapper">
          <h1 class="hero__heading heading--2">
            {heroTitle}
          </h1>
          <p class="hero__txt">
            {heroDescription}
          </p>
          {
            heroCtas.length > 0 && (
              <div class="hero__cta">
                {heroCtas.map(
                  (
                    cta: {
                      link: string
                      text: string
                      analytics_event_label?: string
                      external?: boolean
                    },
                    index: number
                  ) => (
                    <a
                      class={`btn ${index === 0 ? 'hero__btn' : 'hero__btn-secondary'}`}
                      href={cta.link}
                      data-umami-event={
                        cta.analytics_event_label || `Home - ${cta.text}`
                      }
                      {...(cta.external
                        ? { target: '_blank', rel: 'noopener noreferrer' }
                        : {})}
                    >
                      <span>{cta.text}</span> <LinkArrow />
                    </a>
                  )
                )}
              </div>
            )
          }
        </div>
      </div>
    </section>

    {/* Strapi dynamic content blocks */}
    {
      hasStrapiContent && (
        <section class="content-section">
          <div class="content-wrapper">
            <DynamicZone blocks={dynamicContent} />
          </div>
        </section>
      )
    }

    {/* Fallback MDX content */}
    {
      !hasStrapiContent && MdxContent && (
        <section class="content-section">
          <div class="content-wrapper">
            <div class="mdx-content">
              <MdxContent />
            </div>
          </div>
        </section>
      )
    }
  </main>
</BaseLayout>

<style>
  main {
    padding-block-end: var(--space-l);
  }

  section {
    padding-block-start: var(--space-l);
  }

  section:last-child {
    padding-block-end: var(--space-l);
  }

  .hero {
    background-repeat: no-repeat;
    background-size: cover;
    background-position: bottom right;
    background-image: linear-gradient(to right, #007777, #69bcc3);
    background-image: linear-gradient(
      to right,
      oklch(51.54% 0.088 194.77),
      oklch(74.53% 0.082 202.65)
    );
    min-height: 50vh;
    padding-block: var(--space-xl);
    color: var(--color-white);
    display: flex;
    align-items: center;
  }

  .content-wrapper {
    max-width: 1200px;
    margin-inline: auto;
    padding-inline: var(--space-m);
    width: 100%;
  }

  .text-wrapper {
    max-width: 800px;
  }

  .btn {
    border-radius: 10em;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2xs);
    text-decoration: none;
  }

  .btn svg {
    width: 0.6em;
  }

  a {
    text-underline-offset: 4px;
    text-decoration: none;
    cursor: pointer;
  }

  a span {
    text-decoration-line: underline;
    text-decoration-color: transparent;
    text-underline-offset: 4px;
    transition: text-decoration-color ease-in-out 200ms;
  }

  .hero a:hover {
    color: var(--color-white);
  }

  a:hover span {
    text-decoration-color: inherit;
  }

  .hero__heading {
    color: var(--color-white);
    max-width: 14em;
    line-height: 1.2;
    font-weight: 600;
    margin-block-end: var(--space-xs);
    font-size: clamp(2rem, 5vw, 3.5rem);
  }

  .hero__txt {
    margin-block-end: var(--space-m);
    font-size: 1.25rem;
    max-width: 600px;
  }

  .hero__cta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-s);
  }

  .hero__btn {
    background-color: var(--color-white);
    color: var(--color-primary);
    padding: var(--space-xs) var(--space-s);
  }

  .hero__btn span {
    text-decoration-line: underline;
    text-decoration-color: transparent;
  }

  .hero__btn:hover {
    color: var(--color-primary);
  }

  .hero__btn-secondary {
    background-color: transparent;
    border: 2px solid var(--color-white);
    color: var(--color-white);
    padding: var(--space-xs) var(--space-s);
  }

  .hero__btn-secondary:hover {
    background-color: var(--color-white);
    color: var(--color-primary);
  }

  @media screen and (max-width: 600px) {
    .hero__cta {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .content-section {
    padding-block: var(--space-xl);
  }

  .mdx-content {
    max-width: 800px;
    margin-inline: auto;
  }

  .mdx-content :global(h2) {
    font-size: 1.75rem;
    font-weight: 600;
    margin-block: var(--space-l) var(--space-s);
    color: var(--color-primary);
  }

  .mdx-content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-block: var(--space-m) var(--space-xs);
  }

  .mdx-content :global(p) {
    margin-block-end: var(--space-s);
    line-height: 1.6;
  }

  .mdx-content :global(ul) {
    margin-block-end: var(--space-s);
    padding-inline-start: var(--space-m);
  }

  .mdx-content :global(li) {
    margin-block-end: var(--space-xs);
  }

  .mdx-content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .mdx-content :global(a:hover) {
    text-decoration: none;
  }

  .mdx-content :global(.cta-group) {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-s);
    margin-block: var(--space-m);
  }

  .mdx-content :global(.cta-group a) {
    background-color: var(--color-primary);
    color: var(--color-white);
    padding: var(--space-xs) var(--space-s);
    border-radius: 10em;
    text-decoration: none;
  }

  .mdx-content :global(.cta-group a:hover) {
    opacity: 0.9;
  }
</style>
