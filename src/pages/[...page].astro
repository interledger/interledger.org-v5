---
import BaseLayout from '../layouts/BaseLayout.astro'
import DynamicZone from '../components/blocks/DynamicZone.astro'
import LinkArrow from '../../public/img/icon-link-arrow.svg'

export const prerender = false
let slug = Astro.originPathname
slug = slug.replace(/^\/|\/$/g, '')
const preview = Astro.url.searchParams.get('preview') ?? false

async function getPageFromStrapi(slug: string, preview: boolean | string) {
  const token = import.meta.env.STRAPI_PREVIEW_TOKEN
  const base = import.meta.env.STRAPI_URL

  if (!token || !base) {
    console.log('Missing Strapi config, skipping Strapi fetch')
    return null
  }

  const query = preview
    ? `${base}/api/pages?filters[slug][$eq]=${slug}&status=draft&populate[hero][populate]=*&populate[content][populate]=*&populate[seo][populate]=*`
    : `${base}/api/pages?filters[slug][$eq]=${slug}&populate[hero][populate]=*&populate[content][populate]=*&populate[seo][populate]=*`

  try {
    const response = await fetch(query, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (!response.ok) {
      console.log(`Strapi API returned ${response.status} for slug: ${slug}`)
      return null
    }
    const data = await response.json()
    return data.data?.[0] || null
  } catch (error) {
    console.error('Strapi fetch failed:', error)
    return null
  }
}

const data = await getPageFromStrapi(slug, preview)

// Format slug for display (e.g., "about-us" -> "About Us")
const pageTitle = slug
  .split(/[-/]/)
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ')

const title = data?.seo?.metaTitle || data?.title || pageTitle
const description = data?.seo?.metaDescription || null
const hero = data?.hero
const dynamicContent = data?.content || []
---

<BaseLayout title={title} description={description}>
  <main>
    {/* If no data from Strapi, show coming soon page */}
    {
      !data && (
        <section class="coming-soon">
          <div class="content-wrapper">
            <h1>{pageTitle}</h1>
            <p>This page is coming soon.</p>
            <a href="/" class="back-link">
              ‚Üê Back to home
            </a>
          </div>
        </section>
      )
    }

    {/* Hero section */}
    {
      data && hero && (
        <section class="hero">
          <div class="content-wrapper">
            <div class="text-wrapper">
              <h1 class="hero__heading">{hero.title}</h1>
              {hero.description && <p class="hero__txt">{hero.description}</p>}
              {hero.secondaryCtas?.length > 0 && (
                <div class="hero__cta">
                  {hero.secondaryCtas.map(
                    (
                      cta: { link: string; text: string; external?: boolean },
                      index: number
                    ) => (
                      <a
                        class={`btn ${index === 0 ? 'hero__btn' : 'hero__btn-secondary'}`}
                        href={cta.link}
                        {...(cta.external
                          ? { target: '_blank', rel: 'noopener noreferrer' }
                          : {})}
                      >
                        <span>{cta.text}</span> <LinkArrow />
                      </a>
                    )
                  )}
                </div>
              )}
            </div>
          </div>
        </section>
      )
    }

    {/* Dynamic content blocks */}
    {
      data && dynamicContent.length > 0 && (
        <section class="content-section">
          <div class="content-wrapper">
            <DynamicZone blocks={dynamicContent} />
          </div>
        </section>
      )
    }
  </main>
</BaseLayout>

<style>
  main {
    padding-block-end: var(--space-l);
  }

  section {
    padding-block-start: var(--space-l);
  }

  section:last-child {
    padding-block-end: var(--space-l);
  }

  .hero {
    background-repeat: no-repeat;
    background-size: cover;
    background-position: bottom right;
    background-image: linear-gradient(to right, #007777, #69bcc3);
    background-image: linear-gradient(
      to right,
      oklch(51.54% 0.088 194.77),
      oklch(74.53% 0.082 202.65)
    );
    min-height: 40vh;
    padding-block: var(--space-xl);
    color: var(--color-white);
    display: flex;
    align-items: center;
  }

  .content-wrapper {
    max-width: 1200px;
    margin-inline: auto;
    padding-inline: var(--space-m);
    width: 100%;
  }

  .text-wrapper {
    max-width: 800px;
  }

  .hero__heading {
    color: var(--color-white);
    max-width: 14em;
    line-height: 1.2;
    font-weight: 600;
    margin-block-end: var(--space-xs);
    font-size: clamp(2rem, 5vw, 3rem);
  }

  .hero__txt {
    margin-block-end: var(--space-m);
    font-size: 1.125rem;
    max-width: 600px;
  }

  .hero__cta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-s);
  }

  .btn {
    border-radius: 10em;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2xs);
    text-decoration: none;
  }

  .btn svg {
    width: 0.6em;
  }

  .hero__btn {
    background-color: var(--color-white);
    color: var(--color-primary);
    padding: var(--space-xs) var(--space-s);
  }

  .hero__btn:hover {
    opacity: 0.9;
  }

  .hero__btn-secondary {
    background-color: transparent;
    border: 2px solid var(--color-white);
    color: var(--color-white);
    padding: var(--space-xs) var(--space-s);
  }

  .hero__btn-secondary:hover {
    background-color: var(--color-white);
    color: var(--color-primary);
  }

  .content-section {
    padding-block: var(--space-xl);
  }

  .coming-soon {
    min-height: 50vh;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .coming-soon h1 {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-primary);
    margin-block-end: var(--space-s);
  }

  .coming-soon p {
    color: var(--sl-color-gray-2);
    margin-block-end: var(--space-m);
  }

  .back-link {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .back-link:hover {
    text-decoration: none;
  }

  @media screen and (max-width: 600px) {
    .hero__cta {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
