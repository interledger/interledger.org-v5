---
import BaseLayout from '../layouts/BaseLayout.astro'
import DynamicZone from '../components/blocks/DynamicZone.astro'
import LinkArrow from '../../public/img/icon-link-arrow.svg'

export const prerender = false
let slug = Astro.originPathname
slug = slug.replace(/^\/|\/$/g, '')
const preview = Astro.url.searchParams.get('preview') ?? false

async function getPageFromStrapi(slug: string, preview: boolean | string) {
  const token = import.meta.env.STRAPI_PREVIEW_TOKEN
  const base = import.meta.env.STRAPI_URL

  if (!token || !base) {
    console.log('Missing Strapi config, skipping Strapi fetch')
    return null
  }

  const query = preview
    ? `${base}/api/pages?filters[slug][$eq]=${slug}&status=draft&populate[hero][populate]=*&populate[content][populate]=*&populate[seo][populate]=*`
    : `${base}/api/pages?filters[slug][$eq]=${slug}&populate[hero][populate]=*&populate[content][populate]=*&populate[seo][populate]=*`

  try {
    const response = await fetch(query, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (!response.ok) {
      console.log(`Strapi API returned ${response.status} for slug: ${slug}`)
      return null
    }
    const data = await response.json()
    return data.data?.[0] || null
  } catch (error) {
    console.error('Strapi fetch failed:', error)
    return null
  }
}

const data = await getPageFromStrapi(slug, preview)

// Format slug for display (e.g., "about-us" -> "About Us")
const pageTitle = slug
  .split(/[-/]/)
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ')

const title = data?.seo?.metaTitle || data?.title || pageTitle
const description = data?.seo?.metaDescription || null
const hero = data?.hero
const dynamicContent = data?.content || []
---

<BaseLayout title={title} description={description}>
  <main class="pb-space-l">
    {/* If no data from Strapi, show coming soon page */}
    {
      !data && (
        <section class="min-h-[50vh] flex items-center justify-center text-center">
          <div class="mx-auto w-full max-w-wide px-space-m">
            <h1 class="text-2xl font-semibold text-primary mb-space-s">{pageTitle}</h1>
            <p class="text-[var(--sl-color-gray-2)] mb-space-m">This page is coming soon.</p>
            <a href="/" class="text-primary underline hover:no-underline">
              ‚Üê Back to home
            </a>
          </div>
        </section>
      )
    }

    {/* Hero section */}
    {
      data && hero && (
        <section class="bg-gradient-primary bg-no-repeat bg-cover bg-[position:bottom_right] min-h-[40vh] py-space-xl text-white flex items-center">
          <div class="mx-auto w-full max-w-wide px-space-m">
            <div class="max-w-narrow">
              <h1 class="text-white max-w-[14em] leading-[1.2] font-semibold mb-space-xs text-[clamp(2rem,5vw,3rem)]">
                {hero.title}
              </h1>
              {hero.description && (
                <p class="mb-space-m text-[1.125rem] max-w-[600px]">
                  {hero.description}
                </p>
              )}
              {hero.secondaryCtas?.length > 0 && (
                <div class="flex flex-wrap items-center gap-space-s max-[600px]:flex-col max-[600px]:items-start">
                  {hero.secondaryCtas.map(
                    (
                      cta: { link: string; text: string; external?: boolean },
                      index: number
                    ) => (
                      <a
                        class={`group inline-flex items-center gap-space-2xs rounded-pill no-underline cursor-pointer ${index === 0 ? 'bg-white text-primary px-space-s py-space-xs hover:opacity-90' : 'bg-transparent border-2 border-white text-white px-space-s py-space-xs hover:bg-white hover:text-primary'}`}
                        href={cta.link}
                        {...(cta.external
                          ? { target: '_blank', rel: 'noopener noreferrer' }
                          : {})}
                      >
                        <span class="underline decoration-transparent underline-offset-4 transition-[text-decoration-color] duration-200 group-hover:decoration-current">
                          {cta.text}
                        </span>{' '}
                        <LinkArrow />
                      </a>
                    )
                  )}
                </div>
              )}
            </div>
          </div>
        </section>
      )
    }

    {/* Dynamic content blocks */}
    {
      data && dynamicContent.length > 0 && (
        <section class="py-space-xl">
          <div class="mx-auto max-w-content min-w-[360px] max-[1324px]:px-[5%]">
            <DynamicZone blocks={dynamicContent} />
          </div>
        </section>
      )
    }
  </main>
</BaseLayout>
