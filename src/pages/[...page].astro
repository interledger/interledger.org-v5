---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../layouts/BaseLayout.astro'
import DynamicZone from '../components/blocks/DynamicZone.astro'

export const prerender = false
const slug = Astro.originPathname.replace(/^\/|\/$/g, '')

// Try to fetch page from Strapi Pages collection
async function getPageFromStrapi(pageSlug: string) {
  const token = import.meta.env.STRAPI_PREVIEW_TOKEN
  const base = import.meta.env.STRAPI_URL

  if (!token || !base) {
    return null
  }

  try {
    // Use deep populate for dynamic zone content including ambassador relations
    const populateQuery = [
      'populate[hero][populate]=*',
      'populate[seo][populate]=*',
      'populate[content][on][blocks.paragraph][populate]=*',
      'populate[content][on][blocks.cards-grid][populate]=*',
      'populate[content][on][blocks.card-links-grid][populate]=*',
      'populate[content][on][blocks.carousel][populate]=*',
      'populate[content][on][blocks.cta-banner][populate]=*',
      'populate[content][on][blocks.ambassador][populate][ambassador][populate]=*',
      'populate[content][on][blocks.ambassadors-grid][populate][ambassadors][populate]=*'
    ].join('&')

    const response = await fetch(
      `${base}/api/pages?filters[slug][$eq]=${pageSlug}&${populateQuery}`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    )
    if (!response.ok) {
      console.log(`Strapi Pages API returned ${response.status}`)
      return null
    }
    const data = await response.json()
    return data.data?.[0] || null
  } catch (error) {
    console.error('Strapi page fetch failed:', error)
    return null
  }
}

const strapiData = await getPageFromStrapi(slug)

// Fallback to MDX content if Strapi not available
let MdxContent: typeof import('astro').AstroComponentFactory | null = null
let mdxData: {
  title?: string
  description?: string
  heroTitle?: string
  heroDescription?: string
} | null = null

if (!strapiData) {
  const pages = await getCollection('foundation-pages')
  const mdxPage = pages.find((page) => page.data.slug === slug)

  if (mdxPage) {
    const { Content } = await render(mdxPage)
    MdxContent = Content
    mdxData = mdxPage.data
  }
}

// Use Strapi data if available
const pageTitle = slug
  .split(/[-/]/)
  .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ')

const title = strapiData?.seo?.metaTitle || strapiData?.title || mdxData?.title || pageTitle
const description = strapiData?.seo?.metaDescription || mdxData?.description || null
const heroTitle = strapiData?.hero?.title || mdxData?.heroTitle || strapiData?.title || ''
const heroDescription = strapiData?.hero?.description || mdxData?.heroDescription || ''
const dynamicContent = strapiData?.content || []
const hasStrapiContent = strapiData && dynamicContent.length > 0

const isNotFound = !strapiData && !MdxContent
if (isNotFound) Astro.response.status = 404
---

<BaseLayout title={title} description={description}>
  <main class="pb-space-l">
    {isNotFound ? (
      <section class="min-h-[50vh] flex items-center justify-center text-center">
        <div class="mx-auto w-full max-w-wide px-space-m">
          <h1 class="text-2xl font-semibold text-primary mb-space-s">404</h1>
          <p class="text-[var(--sl-color-gray-2)] mb-space-m">
            The page you requested could not be found.
          </p>
          <a href="/" class="text-primary underline hover:no-underline">
            ‚Üê Back to home
          </a>
        </div>
      </section>
    ) : (
      <>
        {heroTitle && (
          <section class="bg-gradient-primary bg-no-repeat bg-cover bg-[position:bottom_right] min-h-[40vh] py-space-xl text-white flex items-center">
            <div class="mx-auto w-full max-w-wide px-space-m">
              <div class="max-w-narrow">
                <h1 class="text-white max-w-[14em] leading-[1.2] font-semibold mb-space-xs text-[clamp(2rem,5vw,3rem)]">
                  {heroTitle}
                </h1>
                {heroDescription && (
                  <p class="mb-space-m text-[1.125rem] max-w-[600px]">
                    {heroDescription}
                  </p>
                )}
              </div>
            </div>
          </section>
        )}

        {/* Strapi dynamic content blocks */}
        {hasStrapiContent && (
          <section class="py-space-xl">
            <div class="mx-auto max-w-content min-w-90 max-[1324px]:px-[5%]">
              <DynamicZone blocks={dynamicContent} />
            </div>
          </section>
        )}

        {/* Fallback MDX content */}
        {!hasStrapiContent && MdxContent && (
          <section class="py-space-xl">
            <div class="mx-auto max-w-content min-w-90 max-[1324px]:px-[5%]">
              <div class="[&_h2]:mt-space-l [&_h2]:mb-space-s [&_h2]:text-[1.75rem] [&_h2]:font-semibold [&_h2]:text-primary [&_h3]:mt-space-m [&_h3]:mb-space-xs [&_h3]:text-[1.25rem] [&_h3]:font-semibold [&_p]:mb-space-s [&_p]:leading-[1.6] [&_ul]:mb-space-s [&_ul]:ps-space-m [&_li]:mb-space-xs [&_a]:text-primary [&_a]:underline [&_a:hover]:no-underline">
                <MdxContent />
              </div>
            </div>
          </section>
        )}
      </>
    )}
  </main>
</BaseLayout>
