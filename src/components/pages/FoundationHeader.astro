---
import FoundationLogo from '../logos/FoundationLogo.astro'
import navigation from '../../config/navigation.json'

interface MenuItem {
  label: string
  href?: string
  openInNewTab?: boolean
}

interface MenuGroup {
  label: string
  href?: string
  items?: MenuItem[]
}

const { mainMenu, ctaButton } = navigation as {
  mainMenu: MenuGroup[]
  ctaButton?: MenuItem
}

// Determine current language from URL path
const currentPath = Astro.url.pathname
const isSpanish = currentPath.startsWith('/es')
const currentLang = isSpanish ? 'es' : 'en-gb'
---

<header
  class="bg-white px-space-m sticky top-0 z-[2] border-t-2 border-gray-header shadow"
  role="banner"
>
  <nav
    class="site-nav flex items-center justify-between xl:grid xl:grid-cols-[auto_1fr_1fr] xl:gap-space-s"
    role="navigation"
    aria-labelledby="block-interledger-mainnavigation-menu"
    id="block-interledger-mainnavigation"
  >
    <h2 class="visually-hidden" id="block-interledger-mainnavigation-menu">
      Main navigation
    </h2>
    <a
      href="/"
      class="w-[11em] flex-none xl:z-[1]"
      aria-label="Interledger Foundation"
      data-umami-event="Site Nav - Logo"
    >
      <FoundationLogo />
    </a>
    <div
      class="site-links-wrapper offscreen"
      data-nav-wrapper
      id="siteNavLinks"
    >
      <ul class="site-nav__links menu--level-1 list-none ps-0 justify-center" id="siteNavMenu">
        {
          mainMenu.map((group) => (
            <li class="menu-item has-submenu menu-item--level-1">
              <button
                aria-expanded="false"
                data-umami-event={`Site Nav - ${group.label}`}
                class="block text-current whitespace-nowrap py-space-s px-space-2xs border-none bg-transparent transition-colors duration-200 hover:bg-gray-header"
              >
                {group.label}
              </button>
              {group.items && group.items.length > 0 && (
                <ul class="menu--level-2 list-none ps-0">
                  {group.items.map((item) => (
                    <li class="menu-item menu-item--level-2">
                      <a
                        href={item.href || '#'}
                        data-umami-event={`Site Nav - ${item.label}`}
                        class="block no-underline py-space-s px-space-2xs text-black hover:bg-gray-header"
                        {...(item.openInNewTab
                          ? { target: '_blank', rel: 'noopener noreferrer' }
                          : {})}
                      >
                        {item.label}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))
        }
      </ul>
      {
        ctaButton && (
          <a
            class="switch-link self-center justify-self-end no-underline py-space-s hover:underline"
            href={ctaButton.href || '#'}
            data-umami-event={`Site Nav - ${ctaButton.label}`}
            {...(ctaButton.openInNewTab
              ? { target: '_blank', rel: 'noopener noreferrer' }
              : {})}
          >
            <a
              href="/"
              class={`language-link ${currentLang === 'en-gb' ? 'is-active' : ''}`}
              hreflang="en-gb"
              data-drupal-link-system-path="<front>"
              aria-current={currentLang === 'en-gb' ? 'page' : undefined}
            >
              EN
            </a>
          </li>
          <li
            data-drupal-link-system-path="<front>"
            class={currentLang === 'es' ? 'is-active' : ''}
            aria-current={currentLang === 'es' ? 'page' : undefined}
          >
            <a
              href="/es"
              class={`language-link ${currentLang === 'es' ? 'is-active' : ''}`}
              hreflang="es"
              data-drupal-link-system-path="<front>"
              aria-current={currentLang === 'es' ? 'page' : undefined}
            >
              ES
            </a>
          </li>
        </ul>
      </div>
    </div>
    <button
      type="button"
      class="site-nav__toggle xl:hidden border-0 bg-transparent py-space-xs"
      aria-controls="siteNavMenu"
      aria-label="Toggle Menu"
      title="Toggle Menu"
      id="siteNavToggle"
    >
      <div id="menuIcon" class="menu-icon">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
  </nav>
</header>

<style>

  @reference "../../styles/tailwind.css";
  /* Submenu arrow indicator */
  .site-nav__links .has-submenu > button::after {
    content: url(/public/img/arrow-menu.svg);
    @apply inline-block w-[9px] ml-2 transition-transform duration-500;
  }

  @media (prefers-reduced-motion) {
    .site-nav__links .has-submenu > button::after {
      transition: transform 0s;
    }
  }

  .site-nav__links .has-submenu > button[aria-expanded='true']::after,
  .site-nav__links .has-submenu > button:hover::after,
  .site-nav__links .has-submenu:has(a:hover) > button::after {
    transform: translateY(30%) rotate(180deg);
  }

  /* Active state styling */
  .menu-item--level-1 > .is-active,
  .menu-item--level-2 > .is-active {
    @apply underline decoration-current decoration-2 underline-offset-8;
  }

  /* Mobile navigation (max-width: 1059px) */
  @media screen and (max-width: 479px) {
    .site-links-wrapper {
      @apply w-full;
    }
  }

  @media screen and (min-width: 480px) and (max-width: 1059px) {
    .site-links-wrapper {
      @apply w-max;
    }
  }

  @media screen and (max-width: 1059px) {
    .site-nav {
      height: var(--site-header-height);
    }

    .site-links-wrapper {
      @apply absolute bg-white right-0 transition-transform duration-slow border-t border-gray-header;
      top: var(--site-header-height);
    }

    .site-links-wrapper.offscreen {
      @apply translate-x-full;
    }

    .site-links-wrapper a,
    .site-nav__links button {
      @apply px-space-s;
    }

    .site-nav-right {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-xs);
      padding-inline: var(--space-s);
    }

    .language-switcher {
      padding-inline-start: 0;
    }

    button[aria-expanded='false'] + .menu--level-2 {
      @apply hidden;
    }

    button[aria-expanded='true'] + .menu--level-2 {
      @apply block;
    }

    .switch-link:hover {
      @apply bg-gray-header;
    }

    /* Hamburger menu icon */
    .menu-icon {
      @apply relative cursor-pointer;
      transform: rotate(0deg);
      transition: 0.5s ease-in-out;
      height: 1em;
      width: 1.5em;
    }

    .menu-icon span {
      @apply block absolute w-full bg-current rounded opacity-100 left-0;
      height: 4px;
      transform: rotate(0deg);
      transition: 0.25s ease-in-out;
    }

    .menu-icon span:nth-child(1) {
      @apply top-0;
    }

    .menu-icon span:nth-child(2),
    .menu-icon span:nth-child(3) {
      top: 50%;
    }

    .menu-icon span:nth-child(4) {
      top: 100%;
    }

    .menu-icon.open span:nth-child(1),
    .menu-icon.open span:nth-child(4) {
      top: 50%;
      width: 0%;
      left: 50%;
    }

    .menu-icon.open span:nth-child(2) {
      transform: rotate(45deg);
    }

    .menu-icon.open span:nth-child(3) {
      transform: rotate(-45deg);
    }

    ul.menu--level-2 {
      @apply ps-space-m;
    }
  }

  /* Desktop navigation (min-width: 1060px) */
  @media screen and (min-width: 1060px) {
    .site-links-wrapper {
      grid-area: 1 / 1 / 2 / 4;
      @apply grid gap-space-s;
      grid-template-columns: minmax(10em, 1fr) 1fr 1fr;
      grid-template-areas: '. menu site';
    }

    .switch-link {
      grid-area: site;
    }

    .site-nav__links {
      grid-area: menu;
      @apply flex items-center;
    }

    .has-submenu {
      @apply relative;
    }

    .site-nav .menu--level-2 {
      @apply absolute bg-white border-l-2 border-gray-header transition-opacity duration-fast;
    }

    .site-nav .menu--level-2 a {
      @apply py-space-2xs px-space-2xs;
    }

    .has-submenu > button[aria-expanded='false'] + ul {
      @apply invisible opacity-0;
    }

    .has-submenu > button[aria-expanded='true'] + ul,
    .menu-item--level-1:hover > .menu--level-2,
    .menu--level-2:hover {
      @apply visible opacity-100 w-max left-0;
      min-width: 100%;
      top: calc(1.4em + var(--space-s) * 2);
      box-shadow:
        2px 3px 6px -3px hsla(0, 0%, 0%, 0.06),
        -2px 3px 6px -3px hsla(0, 0%, 0%, 0.06);
    }
  }
</style>

<script>
  const siteLinksWrapper = document.querySelector('[data-nav-wrapper]')
  const wideNavMinWidth = window.matchMedia('(min-width: 1060px)')
  wideNavMinWidth.addEventListener('change', handleNavDisplayStyles)

  const siteNavToggle = document.getElementById('siteNavToggle')
  const menuIcon = document.getElementById('menuIcon')

  if (document.contains(siteNavToggle)) {
    siteNavToggle?.addEventListener('click', handleMobileNavToggle, false)
  }

  function handleMobileNavToggle() {
    siteLinksWrapper?.classList.toggle('offscreen')
    if (siteLinksWrapper?.getAttribute('class')?.includes('offscreen')) {
      menuIcon?.classList.remove('open')
    } else {
      menuIcon?.classList.add('open')
    }
  }

  function handleNavDisplayStyles(event: MediaQueryListEvent) {
    if (event.matches) {
      siteLinksWrapper?.classList.remove('offscreen')
    } else {
      if (siteLinksWrapper) {
        flashPrevention(siteLinksWrapper)
      }
      siteLinksWrapper?.classList.add('offscreen')
    }
  }

  function flashPrevention(element: Element) {
    element.setAttribute('style', 'display:none')
    setTimeout(() => {
      element.removeAttribute('style')
    }, 10)
  }

  // Site sub-navigation toggle
  const siteNav = document.querySelector('.site-nav__links') as HTMLInputElement

  if (document.contains(siteNav)) {
    const submenuButtons = document.querySelectorAll('.has-submenu > button')

    submenuButtons.forEach((submenuButton) => {
      submenuButton.setAttribute('aria-expanded', 'false')

      submenuButton.addEventListener('click', function (event) {
        const clickedSubmenuButton = event.target
        const allSubmenuButtons = Array.from(submenuButtons)
        const notClickedSubmenuButtons = allSubmenuButtons.filter(
          function (otherSubmenuButton) {
            return otherSubmenuButton !== clickedSubmenuButton
          }
        )
        notClickedSubmenuButtons.forEach((button) => {
          button.setAttribute('aria-expanded', 'false')
        })
        if (clickedSubmenuButton instanceof HTMLElement) {
          if (clickedSubmenuButton?.getAttribute('aria-expanded') === 'true') {
            clickedSubmenuButton?.setAttribute('aria-expanded', 'false')
          } else {
            clickedSubmenuButton?.setAttribute('aria-expanded', 'true')
          }
        }
      })
    })

    siteNav?.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        resetSubMenus()
      }
    })

    document.addEventListener('click', function (event) {
      if (isClickOutside(event, submenuButtons)) {
        resetSubMenus()
      }
    })

    function resetSubMenus() {
      submenuButtons.forEach((submenuButton) => {
        submenuButton.setAttribute('aria-expanded', 'false')
      })
    }
  }

  function isClickOutside(
    event: MouseEvent,
    nodeList: NodeListOf<Element>
  ): boolean {
    let clickedInsideTarget = false
    const eventTarget = event.target as Element
    Array.from(nodeList).forEach(function (element) {
      if (element.contains(eventTarget)) {
        clickedInsideTarget = true
      }
    })
    return !clickedInsideTarget
  }

  // Site sub-navigation highlighting parent menu item
  const devLinks = document.querySelectorAll(
    ".site-nav__links .menu-item--level-2 a[href*='/developers']"
  )
  let currentPath = window.location.pathname

  if (currentPath.endsWith('/')) {
    currentPath = currentPath.slice(0, -1)
  }

  const activeSections = ['/blog']
  devLinks.forEach((devLink) => {
    if (devLink instanceof HTMLAnchorElement) {
      const linkPath = devLink.pathname
      const isExactMatch = linkPath === currentPath

      const isSectionMatch = activeSections.some(
        (section) =>
          currentPath.startsWith(section) && linkPath.startsWith(section)
      )

      if (isExactMatch || isSectionMatch) {
        const parentMenu = devLink.closest('.menu-item--level-1')
        const parentMenuLink = parentMenu?.querySelector('button')

        devLink.classList.add('is-active')
        parentMenuLink?.classList.add('is-active')
      }
    }
  })
</script>
