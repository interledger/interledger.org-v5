---
interface CarouselItem {
  quote: string
  author?: string
  role?: string
  organization?: string
  image?: {
    url: string
    alternativeText?: string
  }
}

interface Props {
  heading?: string
  items: CarouselItem[]
  autoplay?: boolean
  interval?: number
}

const { heading, items, autoplay = true, interval = 5000 } = Astro.props
const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`
---

<div class="max-w-[900px] mx-auto p-space-l">
  {heading && <h2 class="text-[2rem] font-semibold text-primary-fallback text-center mb-space-l">{heading}</h2>}
  <div
    class="relative"
    id={carouselId}
    data-autoplay={autoplay}
    data-interval={interval}
    data-carousel
  >
    <div class="relative overflow-hidden">
      {
        items.map((item, index) => (
          <div
            class="hidden animate-[fadeIn_500ms_ease-in-out] data-[active=true]:block"
            data-index={index}
            data-carousel-slide
            data-active={index === 0 ? 'true' : 'false'}
          >
            <blockquote class="text-center m-0">
              <p class="text-2xl italic leading-relaxed mb-space-m">"{item.quote}"</p>
              {(item.author || item.organization) && (
                <footer class="flex items-center justify-center gap-space-s">
                  {item.image && (
                    <img
                      src={item.image.url}
                      alt={item.image.alternativeText || item.author || ''}
                      class="w-[60px] h-[60px] rounded-full object-cover"
                    />
                  )}
                  <div class="flex flex-col text-left">
                    {item.author && (
                      <cite class="not-italic font-semibold text-primary-fallback">
                        {item.author}
                      </cite>
                    )}
                    {item.role && (
                      <span class="text-sm text-gray">{item.role}</span>
                    )}
                    {item.organization && (
                      <span class="text-sm text-gray">{item.organization}</span>
                    )}
                  </div>
                </footer>
              )}
            </blockquote>
          </div>
        ))
      }
    </div>
    {
      items.length > 1 && (
        <div class="flex items-center justify-center gap-space-m mt-space-l">
          <button
            class="h-10 w-10 rounded-full border text-xl transition-all duration-200 hover:border-primary hover:bg-primary hover:text-white"
            aria-label="Previous slide"
            data-carousel-btn
            style="background: var(--sl-color-bg-nav, #f5f5f5); border-color: var(--sl-color-gray-5, #ddd);"
          >
            &larr;
          </button>
          <div class="flex gap-space-xs">
            {items.map((_, index) => (
              <button
                class="h-[10px] w-[10px] rounded-full border-0 transition-colors duration-200 bg-[var(--sl-color-gray-5)] data-[active=true]:bg-primary hover:bg-primary"
                aria-label={`Go to slide ${index + 1}`}
                data-index={index}
                data-carousel-dot
                data-active={index === 0 ? 'true' : 'false'}
              />
            ))}
          </div>
          <button
            class="h-10 w-10 rounded-full border text-xl transition-all duration-200 hover:border-primary hover:bg-primary hover:text-white"
            aria-label="Next slide"
            data-carousel-btn
            style="background: var(--sl-color-bg-nav, #f5f5f5); border-color: var(--sl-color-gray-5, #ddd);"
          >
            &rarr;
          </button>
        </div>
      )
    }
  </div>
</div>

<script>
  document.querySelectorAll('[data-carousel]').forEach((carousel) => {
    const slides = carousel.querySelectorAll('[data-carousel-slide]')
    const dots = carousel.querySelectorAll('[data-carousel-dot]')
    const buttons = carousel.querySelectorAll('[data-carousel-btn]')
    const prevBtn = buttons[0]
    const nextBtn = buttons[1]
    const autoplay = carousel.dataset.autoplay === 'true'
    const interval = parseInt(carousel.dataset.interval || '5000')

    let currentIndex = 0
    let autoplayTimer: number | null = null

    function showSlide(index: number) {
      slides.forEach((slide) => {
        if (slide instanceof HTMLElement) {
          slide.dataset.active = 'false'
        }
      })
      dots.forEach((dot) => {
        if (dot instanceof HTMLElement) {
          dot.dataset.active = 'false'
        }
      })

      currentIndex = (index + slides.length) % slides.length
      const activeSlide = slides[currentIndex]
      const activeDot = dots[currentIndex]
      if (activeSlide instanceof HTMLElement) {
        activeSlide.dataset.active = 'true'
      }
      if (activeDot instanceof HTMLElement) {
        activeDot.dataset.active = 'true'
      }
    }

    function nextSlide() {
      showSlide(currentIndex + 1)
    }

    function prevSlide() {
      showSlide(currentIndex - 1)
    }

    function startAutoplay() {
      if (autoplay && slides.length > 1) {
        autoplayTimer = window.setInterval(nextSlide, interval)
      }
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer)
        autoplayTimer = null
      }
    }

    prevBtn?.addEventListener('click', () => {
      stopAutoplay()
      prevSlide()
      startAutoplay()
    })

    nextBtn?.addEventListener('click', () => {
      stopAutoplay()
      nextSlide()
      startAutoplay()
    })

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        stopAutoplay()
        showSlide(index)
        startAutoplay()
      })
    })

    startAutoplay()
  })
</script>
