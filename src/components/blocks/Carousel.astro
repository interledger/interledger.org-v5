---
interface CarouselItem {
  quote: string
  author?: string
  role?: string
  organization?: string
  image?: {
    url: string
    alternativeText?: string
  }
}

interface Props {
  heading?: string
  items: CarouselItem[]
  autoplay?: boolean
  interval?: number
}

const { heading, items, autoplay = true, interval = 5000 } = Astro.props
const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`
---

<div class="carousel-wrapper">
  {heading && <h2 class="carousel__heading">{heading}</h2>}
  <div
    class="carousel"
    id={carouselId}
    data-autoplay={autoplay}
    data-interval={interval}
  >
    <div class="carousel__track">
      {
        items.map((item, index) => (
          <div
            class={`carousel__slide ${index === 0 ? 'active' : ''}`}
            data-index={index}
          >
            <blockquote class="carousel__quote">
              <p>"{item.quote}"</p>
              {(item.author || item.organization) && (
                <footer class="carousel__attribution">
                  {item.image && (
                    <img
                      src={item.image.url}
                      alt={item.image.alternativeText || item.author || ''}
                      class="carousel__image"
                    />
                  )}
                  <div class="carousel__author-info">
                    {item.author && (
                      <cite class="carousel__author">{item.author}</cite>
                    )}
                    {item.role && (
                      <span class="carousel__role">{item.role}</span>
                    )}
                    {item.organization && (
                      <span class="carousel__org">{item.organization}</span>
                    )}
                  </div>
                </footer>
              )}
            </blockquote>
          </div>
        ))
      }
    </div>
    {
      items.length > 1 && (
        <div class="carousel__controls">
          <button
            class="carousel__btn carousel__btn--prev"
            aria-label="Previous slide"
          >
            ←
          </button>
          <div class="carousel__dots">
            {items.map((_, index) => (
              <button
                class={`carousel__dot ${index === 0 ? 'active' : ''}`}
                aria-label={`Go to slide ${index + 1}`}
                data-index={index}
              />
            ))}
          </div>
          <button
            class="carousel__btn carousel__btn--next"
            aria-label="Next slide"
          >
            →
          </button>
        </div>
      )
    }
  </div>
</div>

<style>
  .carousel-wrapper {
    max-width: 900px;
    margin-inline: auto;
    padding: var(--space-l);
  }

  .carousel__heading {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-primary);
    text-align: center;
    margin-block-end: var(--space-l);
  }

  .carousel {
    position: relative;
  }

  .carousel__track {
    position: relative;
    overflow: hidden;
  }

  .carousel__slide {
    display: none;
    animation: fadeIn 500ms ease-in-out;
  }

  .carousel__slide.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .carousel__quote {
    text-align: center;
    margin: 0;
  }

  .carousel__quote p {
    font-size: 1.5rem;
    font-style: italic;
    line-height: 1.6;
    color: var(--sl-color-text);
    margin-block-end: var(--space-m);
  }

  .carousel__attribution {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-s);
  }

  .carousel__image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
  }

  .carousel__author-info {
    display: flex;
    flex-direction: column;
    text-align: left;
  }

  .carousel__author {
    font-style: normal;
    font-weight: 600;
    color: var(--color-primary);
  }

  .carousel__role,
  .carousel__org {
    font-size: 0.875rem;
    color: var(--sl-color-gray-2);
  }

  .carousel__controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-m);
    margin-block-start: var(--space-l);
  }

  .carousel__btn {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 200ms ease-in-out;
  }

  .carousel__btn:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  .carousel__dots {
    display: flex;
    gap: var(--space-xs);
  }

  .carousel__dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--sl-color-gray-5);
    border: none;
    cursor: pointer;
    transition: background 200ms ease-in-out;
  }

  .carousel__dot.active,
  .carousel__dot:hover {
    background: var(--color-primary);
  }
</style>

<script>
  document.querySelectorAll('.carousel').forEach((carousel) => {
    const slides = carousel.querySelectorAll('.carousel__slide')
    const dots = carousel.querySelectorAll('.carousel__dot')
    const prevBtn = carousel.querySelector('.carousel__btn--prev')
    const nextBtn = carousel.querySelector('.carousel__btn--next')
    const autoplay = carousel.dataset.autoplay === 'true'
    const interval = parseInt(carousel.dataset.interval || '5000')

    let currentIndex = 0
    let autoplayTimer: number | null = null

    function showSlide(index: number) {
      slides.forEach((slide) => slide.classList.remove('active'))
      dots.forEach((dot) => dot.classList.remove('active'))

      currentIndex = (index + slides.length) % slides.length
      slides[currentIndex].classList.add('active')
      dots[currentIndex]?.classList.add('active')
    }

    function nextSlide() {
      showSlide(currentIndex + 1)
    }

    function prevSlide() {
      showSlide(currentIndex - 1)
    }

    function startAutoplay() {
      if (autoplay && slides.length > 1) {
        autoplayTimer = window.setInterval(nextSlide, interval)
      }
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer)
        autoplayTimer = null
      }
    }

    prevBtn?.addEventListener('click', () => {
      stopAutoplay()
      prevSlide()
      startAutoplay()
    })

    nextBtn?.addEventListener('click', () => {
      stopAutoplay()
      nextSlide()
      startAutoplay()
    })

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        stopAutoplay()
        showSlide(index)
        startAutoplay()
      })
    })

    startAutoplay()
  })
</script>
