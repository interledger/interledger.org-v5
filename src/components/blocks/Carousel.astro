---
interface CarouselItem {
  quote: string
  author?: string
  role?: string
  organization?: string
  image?: {
    url: string
    alternativeText?: string
  }
}

interface Props {
  heading?: string
  items: CarouselItem[]
  autoplay?: boolean
  interval?: number
}

const { heading, items, autoplay = true, interval = 5000 } = Astro.props
const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`
---

<div class="max-w-[900px] mx-auto p-space-l">
  {heading && <h2 class="text-[2rem] font-semibold text-primary-fallback text-center mb-space-l">{heading}</h2>}
  <div
    class="carousel relative"
    id={carouselId}
    data-autoplay={autoplay}
    data-interval={interval}
  >
    <div class="relative overflow-hidden">
      {
        items.map((item, index) => (
          <div
            class={`carousel__slide ${index === 0 ? 'active' : ''}`}
            data-index={index}
          >
            <blockquote class="text-center m-0">
              <p class="text-2xl italic leading-relaxed mb-space-m">"{item.quote}"</p>
              {(item.author || item.organization) && (
                <footer class="flex items-center justify-center gap-space-s">
                  {item.image && (
                    <img
                      src={item.image.url}
                      alt={item.image.alternativeText || item.author || ''}
                      class="w-[60px] h-[60px] rounded-full object-cover"
                    />
                  )}
                  <div class="flex flex-col text-left">
                    {item.author && (
                      <cite class="not-italic font-semibold text-primary-fallback">
                        {item.author}
                      </cite>
                    )}
                    {item.role && (
                      <span class="text-sm text-gray">{item.role}</span>
                    )}
                    {item.organization && (
                      <span class="text-sm text-gray">{item.organization}</span>
                    )}
                  </div>
                </footer>
              )}
            </blockquote>
          </div>
        ))
      }
    </div>
    {
      items.length > 1 && (
        <div class="flex items-center justify-center gap-space-m mt-space-l">
          <button
            class="carousel__btn"
            aria-label="Previous slide"
          >
            &larr;
          </button>
          <div class="flex gap-space-xs">
            {items.map((_, index) => (
              <button
                class={`carousel__dot ${index === 0 ? 'active' : ''}`}
                aria-label={`Go to slide ${index + 1}`}
                data-index={index}
              />
            ))}
          </div>
          <button
            class="carousel__btn"
            aria-label="Next slide"
          >
            &rarr;
          </button>
        </div>
      )
    }
  </div>
</div>

<style>

  @reference "../../styles/tailwind.css";
  .carousel__slide {
    @apply hidden;
    animation: fadeIn 500ms ease-in-out;
  }

  .carousel__slide.active {
    @apply block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .carousel__btn {
    @apply rounded-full w-10 h-10 text-xl cursor-pointer transition-all duration-200 border;
    background: var(--sl-color-bg-nav, #f5f5f5);
    border-color: var(--sl-color-gray-5, #ddd);
  }

  .carousel__btn:hover {
    @apply text-white;
    background: var(--color-primary);
    border-color: var(--color-primary);
  }

  .carousel__dot {
    @apply w-[10px] h-[10px] rounded-full border-none cursor-pointer transition-colors duration-200;
    background: var(--sl-color-gray-5, #ddd);
  }

  .carousel__dot.active,
  .carousel__dot:hover {
    background: var(--color-primary);
  }
</style>

<script>
  document.querySelectorAll('.carousel').forEach((carousel) => {
    const slides = carousel.querySelectorAll('.carousel__slide')
    const dots = carousel.querySelectorAll('.carousel__dot')
    const buttons = carousel.querySelectorAll('.carousel__btn')
    const prevBtn = buttons[0]
    const nextBtn = buttons[1]
    const autoplay = carousel.dataset.autoplay === 'true'
    const interval = parseInt(carousel.dataset.interval || '5000')

    let currentIndex = 0
    let autoplayTimer: number | null = null

    function showSlide(index: number) {
      slides.forEach((slide) => slide.classList.remove('active'))
      dots.forEach((dot) => dot.classList.remove('active'))

      currentIndex = (index + slides.length) % slides.length
      slides[currentIndex].classList.add('active')
      dots[currentIndex]?.classList.add('active')
    }

    function nextSlide() {
      showSlide(currentIndex + 1)
    }

    function prevSlide() {
      showSlide(currentIndex - 1)
    }

    function startAutoplay() {
      if (autoplay && slides.length > 1) {
        autoplayTimer = window.setInterval(nextSlide, interval)
      }
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer)
        autoplayTimer = null
      }
    }

    prevBtn?.addEventListener('click', () => {
      stopAutoplay()
      prevSlide()
      startAutoplay()
    })

    nextBtn?.addEventListener('click', () => {
      stopAutoplay()
      nextSlide()
      startAutoplay()
    })

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        stopAutoplay()
        showSlide(index)
        startAutoplay()
      })
    })

    startAutoplay()
  })
</script>
