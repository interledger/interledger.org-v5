name: Merge to staging Workflow

on:
  # Only after PRs are merged to staging (preview)
  # WARNING: Do not trigger on pull_request events. We do not want forks to run code on our self-hosted runner,
  # and pull_request events run for forks. This workflow should only run on push to staging.
    push:
      branches:
        - staging

concurrency:
  # Ensure only one instance of this workflow runs at a time to avoid multiple rebuilds
  group: staging-merge
  cancel-in-progress: false

jobs:
  rebuild-strapi:

    # Runs on self hosted runner called strapi-vm
    runs-on: strapi-vm

    steps:
        - name: Ensure push is from merged PR
          id: pr_merge_check
          uses: actions/github-script@v7
          with:
            script: |
              const owner = context.repo.owner
              const repo = context.repo.repo
              const sha = context.sha

              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: sha,
                per_page: 100
              })

              const mergedIntoStaging = prs.some((pr) =>
                pr.merged_at && pr.base && pr.base.ref === 'staging'
              )

              core.setOutput('merged_pr', mergedIntoStaging ? 'true' : 'false')
              if (!mergedIntoStaging) {
                core.notice('No merged PR into staging found for this commit; workflow steps will be skipped.')
              }

      # Only rebuild strapi if there are changes in the cms/ directory to avoid unnecessary rebuilds
        - name: Detect cms changes
          id: cms_changes
          if: steps.pr_merge_check.outputs.merged_pr == 'true'
          shell: bash
          run: |
            set -euo pipefail

            cd /home/strapi/interledger.org-v5
            git fetch --quiet

            if git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep -q '^cms/'; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
              echo "CMS changes detected; rebuild will run."
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
              echo "No CMS changes detected; rebuild will be skipped."
            fi

        - name: Rebuild strapi cms
          if: steps.pr_merge_check.outputs.merged_pr == 'true' && steps.cms_changes.outputs.changed == 'true'
          shell: bash
          run: |
            set -euo pipefail

            # Add pnpm to PATH (not loaded from .bashrc in GitHub Actions)
            export PNPM_HOME="/home/strapi/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"

            cd /home/strapi/interledger.org-v5-staging

            # Ensure pull fails instead of creating merge commits
            git fetch
            git pull --ff-only

            # Defensive check: fail if git index contains unresolved conflicts
            if [ -n "$(git ls-files -u)" ]; then
              echo "Unresolved git conflicts detected after pull"
              exit 1
            fi

            cd /home/strapi/interledger.org-v5-staging/cms
            # Stops the service while we are busy
            sudo systemctl stop strapi.service
            # Perform installs in case there are new dependencies from the merged PRs
            pnpm install
            # Rebuild with more memory to avoid OOM errors during build
            NODE_OPTIONS="--max-old-space-size=4096" pnpm run build
            sudo systemctl start strapi.service
            sleep 5
            sudo systemctl status strapi.service

